<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class=""> <!--<![endif]-->
<head>
	
	<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="/favicon.ico">
	<title>Blog | Okta Developer</title>
	<meta name="description" content="Secure, scalable, and highly available authentication and user management for any app.">

	<link rel="canonical" href="http://developer.okta.com/blog">

	<link rel="stylesheet" href="/assets/vendor/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/assets/css/animate.css">
	<link rel="stylesheet" href="/assets/css/master.css">
	<link rel="stylesheet" href="/assets/css/page-blog.css">
	<link rel="stylesheet" href="/assets/css/responsive.css">


  
	<script type="text/javascript" defer="defer" src="/assets/js/jquery.min.js"></script>
	<script type="text/javascript" defer="defer" src="/assets/js/tabber.js"></script>
	<script type="text/javascript" defer="defer" src="/assets/js/pacnav.js"></script>
	<script type="text/javascript" defer="defer" src="/assets/js/master.js"></script>
	<script type="text/javascript" defer="defer" src="/assets/js/scrollspy.js"></script>

	
	<!-- TypeKit -->
	<script src="//use.typekit.net/pls8pog.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>
	<!-- GA -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-15777010-3', 'auto');
		ga('send', 'pageview');
	</script>
</head>

	
<body>
	
	<header class="site-header">
	<div class="wrap">

		<h1 class="site-title"><a href="/">Okta Developer</a></h1>

		<nav id="primary-nav" class="site-nav loaded">
			<ul>
				<li><a href="/product/">Product</a></li>
				<li><a href="/pricing/">Pricing</a></li>
				<li><a href="/customers/">Customers</a></li>
				<li><a href="/docs/guides/overview.html">Docs</a></li>
				<li><a href="/discussion/">Discussion</a></li>
				<li class="has-dropdown"><a href="#">Support</a>
					<div class="dropdown-window">
						<p class="stack-overflow">
							Post your question on <a href="http://stackoverflow.com/search?q=okta" target="_blank">Stack Overflow</a>.<br />
							We'll answer it within 24 hours.
						</p>
						<p class="email">
							Email us:<br />
							<a href="mailto:developers@okta.com">developers@okta.com</a>
						</p>
						<p class="tel">
							Call us:<br />
							<a href="tel:18777227871">1 (877) 722-7871</a>
						</p>
					</div>
				</li>
			</ul>
		</nav>

		<a href="/search" class="gsc-trigger search-button"></a>


		<div class="search-container">
			<div class="gsc-container">
				<script defer="defer">
					(function() {
						var cx = '005121479574088032773:mmh_vhv8uns';
						var gcse = document.createElement('script');
						gcse.type = 'text/javascript';
						gcse.async = true;
						gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
						'//cse.google.com/cse.js?cx=' + cx;
						var s = document.getElementsByTagName('script')[0];
						s.parentNode.insertBefore(gcse, s);
					})();
				</script>
				<gcse:searchbox-only resultsUrl="/search" enableAutoComplete="true"></gcse:searchbox-only>
			</div>
		</div>
		<a href="https://www.okta.com/developer/signup/" class="cta-button button--small">Get Started</a>

	</div>
</header>

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-P6JKVN"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P6JKVN');</script>
<!-- End Google Tag Manager -->


	
	<div class="page-content">
		
		
			
		<section id="blog-index" class="section--full-width index">

	<div class="wrap blog">
		
		
		
		<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/05/08/software-engineering-design-principles">Okta Software Engineering Design Principles</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-jon_todd.jpg"
	           alt="avatar-jon_todd.jpg"
	           class="author-avatar">
	      <address>Jon Todd</address>
	      &nbsp;
		  
		    <a class="social_link" href="https://github.com/jontodd"><i class="fa fa-github-square"></i></a>
		  
		  
		    <a class="social_link" href="https://twitter.com/jonrtodd"><i class="fa fa-twitter-square"></i></a>
		  
		  
		  
		    <a class="social_link" href="http://www.jontodd.com"><i class="fa fa-external-link-square"></i></a>
		  
	      <span class="sepr">&middot;</span>
	      <time datetime="2015-05-08">
	      May 8, 2015
	      </time>
	    </div>
	  </header>

	  <section class="post-content">
	    <p>Okta has been an agile development shop since the beginning. One important
aspect of being agile is enabling a mix of bottom-up and top-down decision
making. Specifically where high level vision and strategy is clearly
communicated enabling teams to autonomously deliver value while also feeding back
learnings from the trenches to inform the high level
goals.<sup id="fnref:the-knowledge-creating-company"><a href="#fn:the-knowledge-creating-company" class="footnote">1</a></sup> Below are the tacit engineering design
principles we’ve used to guide development at Okta. They continue to evolve
as we experiment and learn.</p>

<h2 id="create-user-value">1. Create User Value</h2>

<p>First and foremost, writing software is about creating value for users. This
seems straight forward, but as systems evolve and become more complex we
start introducing more abstraction and layering which brings us further away
from the concrete problem we’re trying to solve. It’s important to keep in mind
the reason for writing software in the first place and use the understanding
of the audience to inform priority.</p>

<p>At Okta, our entire company is aligned on this principle because our #1 core
value is <a href="https://www.okta.com/customers/focus-on-customer-success.html">customer
success</a>.  In
practice this means there’s almost always a number of customers eager to beta a
new feature we’re working on. We collaborate closely with customers while
building features allowing for continuous feedback as we iterate and get
changes out in weekly sprints.</p>

<p><img src="http://imgs.xkcd.com/comics/the_general_problem.png" alt="xkcd - pass the salt" /></p>

<h2 id="keep-it-simple">2. Keep it Simple</h2>

<blockquote>
  <p>Everything should be made as simple as possible, but no simpler — Albert
  Einstein </p>
</blockquote>

<p>This truism has been around for ages, and it goes hand-in-hand with the
first principle.  If it doesn’t add value to users now, <a href="http://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">you ain’t gonna
need it - YAGNI</a>!</p>

<p>We all encounter overly complex code where it’s nearly impossible to reason
about what it does. Part of this confusion is because it’s
generally <a href="http://www.joelonsoftware.com/articles/fog0000000069.html">harder to read code than to write
it</a> but beyond 
that, there are clearly fundamental qualities of some code making it
more intuitive than other code. There’s a lot of prior art on this topic and a
great place to start is <a href="http://books.google.com/books?id=dwSfGQAACAAJ">Clean
Code</a> by Robert C. Martin, aka
Uncle Bob. The book breaks down the qualities of code which make it
intuitive, and provides a framework for reasoning about code quality. </p>

<p>Here are some guiding principles about writing clean code we use in practice
which are also covered in the book.</p>

<p>Clean code:</p>

<ul>
  <li>Makes intent clear, use comments when code isn’t expressive enough</li>
  <li>Can be read and enhanced by others (or the author after a few
years)</li>
  <li>Provides one way, rather than many, to do a particular task</li>
  <li>Is idomatic</li>
  <li>Is broken into pieces which each does one thing and does it well</li>
</ul>

<p>At the end of the day there is no substitue for experience, like any craft,
writing clean code takes practice. At Okta every engineer is constantly honing
their skills, we rely heavily on code reviews and pair programming to help hone
each other’s skills. </p>

<p><img src="/assets/img/2015-05-08-software-engineering-design-principles-code_quality_wtfs_per_minute.jpg" alt="wtfs per minute" /></p>

<h2 id="know-thy-service-with-data">3. Know Thy-Service With Data</h2>

<p>In the world of “big data” this point needs little explanation. Okta collects
massive amounts of operational data about our systems to:</p>

<ul>
  <li>Monitor health</li>
  <li>Monitor performance</li>
  <li>Debug issues</li>
  <li>Audit security</li>
  <li>Make decisions</li>
</ul>

<p>With every new feature we add, developers are responsible for ensuring that
their designs provide visibility into these dimensions. In order to make this an
efficient process we’ve invested in: </p>

<ul>
  <li>Runtime logging control toggling by level, class, tenant, user </li>
  <li>Creation of dashboards and alerts is self-service </li>
  <li>Every developer has access to metrics and anonymous unstructured data</li>
  <li>Request ID generated at edge is passed along at every layer of stack for
correlation</li>
  <li>Engineering control panel for common operational tasks like taking threaddumps</li>
</ul>

<p>Technologies we use to gain visibility include: PagerDuty, RedShift,
Zabbix, ThousandEyes, Boundary, Pingdom, App Dynamics, Splunk, ELK, S3.</p>

<h2 id="make-failure-cheap">4. Make Failure Cheap</h2>

<p>Every software system will experience failures and all code has bugs. While we
constantly work at having fewer, it’s unrealistic to assume they won’t occur. So,
in addition to investing in prevention, we invest in making failure cheap.</p>

<p>The cost of failure becomes significantly more expensive 
further out on the development timeline. Making adjustments 
during requirements gather and design are significantly cheaper than 
finding issues in production.<sup id="fnref:agile-cost-curve"><a href="#fn:agile-cost-curve" class="footnote">2</a></sup> </p>

<p><img src="/assets/img/2015-05-08-software-engineering-design-principles-agile-cost-curve.png" alt="cost curve of development" /></p>

<p>One fundamental we take from both Agile and XP is to invest in pushing failure
as early in the development timeline as possible. We mitigate failures from
poor requirements gathering by iterating quickly with the customer as described in
Principle 1. Once we get to design and development we make failure cheap through: </p>

<ul>
  <li>Design reviews with stakeholders ahead of writing code </li>
  <li>TDD - developers write all tests for their code; test isn’t a separate phase
from development </li>
  <li>Keeping master stable - check-in to master is gated by passing all unit,
functional and UI tests </li>
  <li>Developers can trigger CI on any topic branch; CI is massively parallelized
over a cloud of fast machines</li>
</ul>

<p>Since our testing phase is done during development the next phase is production
deployments. At this phase we reduce the cost of failure by:</p>

<ul>
  <li>Hiding beta features behind flags in the code</li>
  <li>Incremental rollout first to test accounts and then in batches of customers</li>
  <li>Automated deployment process</li>
  <li>Code and infrastructure is forward and backward compatible allowing
rollback</li>
  <li>Health check and automatically remove down nodes</li>
  <li>Return a degraded / read-only response over nothing at all</li>
</ul>

<blockquote>
  <p>An escalator can never break; it can only become stairs – Mitch Hedberg</p>
</blockquote>

<h2 id="automate-everything">5. Automate Everything</h2>

<p>All tasks performed routinely should
be automated. These are automation principles we follow:</p>

<ul>
  <li>Automate every aspect of the deployment including long running db migrations</li>
  <li>All artifacts are immutable and versioned</li>
  <li>All code modules get dependencies automatically from central artifact server</li>
  <li>Creation of base images and provisioning of new hardware is automated</li>
  <li>All forms of testing are automated </li>
  <li>Development environment setup is automated</li>
</ul>

<p>Tools we use:</p>

<ul>
  <li>AWS - Automated provisioning of hardware </li>
  <li>Chef - Configuration managment</li>
  <li>Ansible - Automated deployment orchestration</li>
  <li>Jenkins - Continuous integration</li>
  <li>Gearman - To get Jenkins to scale</li>
  <li>Docker - Containerizing services</li>
</ul>

<h2 id="with-performance-less-is-more">6. With Performance, Less is More</h2>

<p>We find especially with performance, there are typically huge wins to be had in
up front design decisions which may come at very little to no cost. Our design
mantras for performance are:</p>

<ol>
  <li>Don’t do it</li>
  <li>Do it, but don’t do it again</li>
  <li>Do it less</li>
  <li>Do it later</li>
  <li>Do it when they’re not looking</li>
  <li>Do it concurrently</li>
  <li>Do it cheaper</li>
</ol>

<p>In practice we implement a number of strategies to limit risk to poorly
performing code:</p>

<ul>
  <li>Major new features and performance tunings live behind feature flags allowing
slow rollout and tuning in real life environment</li>
  <li>Chunk everything that scales on order of N. When N is controlled by customer
enforce limits and design for infinity.</li>
  <li>Slow query and frequent query monitoring to detect poor access patterns</li>
</ul>

<p><img style="max-width:300px" src="/assets/img/2015-05-08-software-engineering-design-principles-more_is_less.jpg" alt="if less is more, does that mean more is less?" /></p>

<h3 id="reference">Reference</h3>

<div class="footnotes">
  <ol>
    <li id="fn:the-knowledge-creating-company">
      <p>Ikujiro Nonaka, and Hirotaka Takeuchi. The Knowledge Creating Company. Oxford University Press, 1995. Print. https://books.google.com/books/about/The_Knowledge_creating_Company.html?id=B-qxrPaU1-MC <a href="#fnref:the-knowledge-creating-company" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:agile-cost-curve">
      <p>Scott Ambler. Examining the Agile Cost of Change Curve. Website. http://www.agilemodeling.com/essays/costOfChange.htm <a href="#fnref:agile-cost-curve" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

	  </section>



	</article>
</div>
</section>


		
		
		
		<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/05/08/productionalizing-active-mq">Productionalizing ActiveMQ</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-okta_logo.jpg"
	           alt="avatar-okta_logo.jpg"
	           class="author-avatar">
	      <address>Okta Staff</address>
	      &nbsp;
		  
		    <a class="social_link" href="https://github.com/okta"><i class="fa fa-github-square"></i></a>
		  
		  
		  
		  
	      <span class="sepr">&middot;</span>
	      <time datetime="2015-05-08">
	      May 8, 2015
	      </time>
	    </div>
	  </header>

	  <section class="post-content">
	    <p>This post describes our odyssey with ActiveMQ, an open-source version of the Java Messaging Service (JMS) API. We use ActiveMQ as the message broker among our app servers.</p>

<p>First, a word of thanks. To overcome the challenges we faced with ActiveMQ, we are greatly indebted to a very thorough description of an <a href="https://bugs.openjdk.java.net/browse/JDK-8054446">OpenJDK bug</a>, as well as some other <a href="https://svn.apache.org/repos/asf/harmony/standard/classlib/trunk/modules/concurrent/src/main/java/java/util/concurrent/ConcurrentLinkedQueue.java">online resources</a>. If you’re having problems with ActiveMQ, read on. Maybe our story can help you.</p>

<h2 id="growing-pains">Growing Pains</h2>

<p>Our problems with ActiveMQ date all the way back to 2012. They centered around high memory and CPU usage, message timeout errors, and message queue delays.</p>

<p>Let’s pick up the action in the spring 2014. At that time we were battling a new wave of timeout storms and message queue delays caused by our mixed ActiveMQ configuration (broker <strong>5.4.1</strong>, client <strong>5.7</strong>) and increasing traffic on our site.</p>

<p>Of course we welcomed the growth in traffic as a byproduct of our growing business. And although we did plan to address our mixed ActiveMQ configuration, we decided to delay doing so at that time, opting instead to tune the configuration. So we increased the maximum session size from 500 to 2000, and the page size from 200 to 2000 messages. Increasing the page size served to minimize “hung queue” scenarios — a side effect of using <a href="http://docs.oracle.com/cd/E19798-01/821-1841/bncer/index.html">message selectors</a>.</p>

<h2 id="another-inflection-point">Another Inflection Point</h2>

<p>Business and site traffic continued to grow, contributing to another inflection point in the fall of 2014. Timeout storms, CPU spikes, and memory issues returned. It was clear that we could no longer put off upgrading to a newer version of ActiveMQ.</p>

<p>We decided to skip versions 5.7 and 5.8 in favor of 5.10, mainly because 5.7 was considered unstable, and 5.10 provided improved failover performance.</p>

<p>Would this upgrade finally deliver the stability that had eluded us for so long?</p>

<h2 id="when-upgrades-bite-back">When Upgrades Bite Back</h2>

<p>Unfortunately, no. Within 24 hours, memory usage soared, CPUs spiked, and instability returned. Note the dramatic CPU spikes in the following screenshot.</p>

<p><img style="width:50%" src="/assets/img/2015-05-08-productionalizing-active-mq-cpu-graph-1.png" alt="Active MQ CPU" /></p>

<p>To prevent these issues from impacting customers, we were forced to restart brokers, which is always an option of
last resort. Restarting brokers is a delicate operation, which can entail a less-than-smooth failover,
risking message loss.</p>

<p>We immediately increased memory, but within a day or two we ran out of memory again.</p>

<h2 id="searching-for-the-root-cause">Searching for the Root Cause</h2>

<p>An online search turned up an <a href="https://bugs.openjdk.java.net/browse/JDK-8054446">OpenJDK bug</a> that identified an out of memory issue in the
<em>ConcurrentLinkedQueue</em>, which is a class in the <strong>java.util.concurrent</strong> package included in <strong>JVM version 1.6</strong>.
When working properly, <em>ConcurrentLinkedQueue</em> allows elements to be added and removed from the queue in a
thread-safe manner.</p>

<p>The bug caused a null object to be created whenever an element at the end of the queue was added and
then deleted. This behavior is particularly unfavorable to the way we use queuing. We call ActiveMQ
to create and destroy objects in the queue very quickly, tens of millions of times a day, as users
and agents connect to Okta. As a result, null objects rapidly fill up the queue, memory usage soars,
and CPUs spike.</p>

<h2 id="conference-call">Conference Call</h2>

<p>With the site at risk of impacting customer authentication, several key engineers, including Hector
Aguilar, Okta’s CTO and SVP of Engineering, met on a Saturday afternoon conference call. Discussion was intense, and our options were few and unappealing:
(a) revert all the way back to broker version 5.4.1, or (b) upgrade to broker version 5.11, which
was still unreleased and might introduce new problems.</p>

<p>As team members recall, Hector said very little during the first half of the meeting.</p>

<p>A bug in the JVM surprised Hector, as critical JVM bugs are relatively rare. Fortunately, the
OpenJDK bug we’d found included a very thorough description of the problem, as well as sample code
to reproduce it.</p>

<p>Initially motivated by curiosity, Hector analyzed the code and the bug description. He saw where the
problem was, and then checked online to see if it had been fixed in newer JDK versions. He noticed that
several things were changing in the class, and that others had attempted to resolve the bug in
different ways, but none that would solve our particular problem. Hector developed a very simple fix
of his own, trying to remain consistent with the work of others. He then verified his fix using the
provided sample code.</p>

<p>The JVM has a mechanism called <em>endorsed libraries</em> that allows developers to override an existing
class with a new class, effectively patching the JVM. Hector used this mechanism, packaged his fix
into a jar file, tried it against ActiveMQ, and found that it worked.</p>

<p>The mood and direction of the meeting shifted dramatically when Hector said, <em>“Guys, I have a wild
idea. What if we patch the JVM?”</em> As none of us had ever patched a JVM before, this seemed like a novel approach, even a long
shot.</p>

<h2 id="the-fix">The Fix</h2>

<p>Hector sent his JVM patch and sample code to the team and walked us through it. First, he explained
why the other attempted fixes wouldn’t solve our particular problem. He then demonstrated how his override effectively patched the original (faulty) removal method. Members of the
team volunteered to test the override at scale with our simulated environments. Within a few hours,
we were fairly sure that Hector’s fix would work.</p>

<h2 id="deploying-the-patch">Deploying the Patch</h2>

<p>We deployed the patch and restarted brokers. It was a success! ActiveMQ no longer ran out of memory
and the CPU spikes ceased.</p>

<p><img style="width:50%" src="/assets/img/2015-05-08-productionalizing-active-mq-cpu-graph-2.png" alt="Active MQ CPU" /></p>

<p>Some minor memory leaks remained, but these were eliminated by upgrading to <strong>java-1.7.0</strong>.</p>

<h2 id="stable-and-looking-at-other-solutions">Stable, and looking at other solutions</h2>

<p>Patching the <em>ConcurrentLinkedQueue</em> with ActiveMQ v5.10 and upgrading to java-1.7.0 provided
acceptable stability and faster failover performance. While this is a significant improvement over
where we were last fall, our goal is <strong>zero failover time</strong>, which ActiveMQ cannot deliver. So, we’re exploring other messaging solutions.</p>

<p>In telling our story, we couldn’t resist tooting our own horn a bit. How many CTOs actually get
their hands dirty tackling product issues? Our CTO doesn’t code very often, but when
he does, he patches the JVM.</p>

	  </section>



	</article>
</div>
</section>


		
		
		
		<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/23/android-unit-testing-part-4">Android Unit Testing Part IV&#58; Mocking</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  
		    <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  
		  
		  
		  
		    <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  
	      <span class="sepr">&middot;</span>
	      <time datetime="2015-04-23">
	      April 23, 2015
	      </time>
	    </div>
	  </header>

	  <section class="post-content">
	    <p><em>This is the third of a four part series on Android Unit Testing. In
the last two articles I discussed the <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">general principles of having
good
tests</a>
and the way to <a href="/blog/2015/04/07/android-unit-testing-part-2">run Android tests on JVM making them
fast</a> and <a href="/blog/2015/04/14/android-unit-testing-part-3/">how to make
your code less coupled</a>. 
This article will explain how to make tests isolated.</em></p>

<p>We need to mock a dependency, inject it, and then modify our test to
indicate that we are not testing an end-to-end scenario anymore, but
are now testing just one class at a time.</p>

<ul>
  <li>
    <p>Modify application Gradle file</p>

    <p>Add the following code under the dependency section:</p>

    <pre><code>androidTestCompile ‘org.easymock:easymock:3.1'
</code></pre>
  </li>
  <li>
    <p>Replace <code>FooTest</code> with the following code:</p>

    <pre><code>package com.example.myapplication;
     
import junit.framework.Assert;
      
import org.easymock.EasyMockSupport;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.RobolectricTestRunner;
    
import static org.easymock.EasyMock.expect;
    
@RunWith(RobolectricTestRunner.class)
public class FooTest extends EasyMockSupport {
    Foo sut;
    
    // Mocks
    Bar barMock;
    
    @Before
    public void setUp() {
        sut = new Foo();
    
        // Create mocks
        barMock = createMock(Bar.class);
    
        // Inject mock
        InjectHelper.injectMock(sut, barMock);
    }
    
    @Test
    public void testGetFoo_returns4() {
        // Arrange
        expect(barMock.getBar()).andReturn(4);
        replayAll();
    
        // Act
        int actualResult = sut.getFoo();
    
        // Assert
        verifyAll();
        Assert.assertEquals(4, actualResult);
    }
}
</code></pre>
  </li>
  <li>
    <p>Create a class <code>InjectHelper</code> under <code>androidTest</code></p>

    <p>(I believe the original code for injecting fields is from <strong>Spring</strong>; however, it was modified afterwards.)</p>

    <pre><code>package com.example.myapplication;
      
import java.lang.reflect.Field;
import javax.inject.Inject;
    
public class InjectHelper {
        
    @SuppressWarnings("unchecked")
    public static void injectMock(Object target, Object mock)
    {
        Class targetClass = target.getClass();
        do {
            Field[] fields = targetClass.getDeclaredFields();
            // Iterate through all members
            for (Field field : fields) {
                // Skip all non injectable members
                if (field.getAnnotation(Inject.class) == null)
                    continue;
    
                // Make private/prptected members accessible
                field.setAccessible(true);
    
                // Get a class of the member
                Class injectedClass = field.getType();
                Class mockClass = mock.getClass();
    
                // Check that mock is essentially the same class
                if (!injectedClass.isAssignableFrom(mockClass))
                    continue;
    
                try {
                    // Inject mock
                    field.set(target, mock);
                } catch (IllegalAccessException e)
                {
                    throw new RuntimeException(e);
                }
    
                // return accessibility
                field.setAccessible(false);
            }
            targetClass = targetClass.getSuperclass();
        }
        while (targetClass != null &amp;&amp; targetClass != Object.class);
    }
}
</code></pre>

    <p><strong>Woo-Hoo! We are finally done!</strong></p>

    <p>Now, your tests are:</p>

    <ul>
      <li><strong>fast</strong> — they are executed on a JVM and don’t require going to the network or a persistent layer.</li>
      <li><strong>repeatable</strong> — they don’t depend on emulator stability or network quality.</li>
      <li>(potentially!) <strong>simple</strong> and <strong>consistent</strong> — there is a lot of good information out there on how to write good unit tests.</li>
      <li><strong>independent</strong> — since the persistent layer isn’t used, one test won’t influence another.</li>
    </ul>

    <p>In addition to all of this awesomeness, your code should actually be
better off, too. Hopefully writing unit tests will force you to
simplify classes with too many dependencies and more carefully think
through interfaces.</p>

    <p>Thanks!</p>

    <p>Let me mention several people who helped me to put this article
together: <a href="https://www.linkedin.com/pub/william-dawson/43/140/837">Wills Dawson</a> made the initial move to use Robolectric,
<a href="https://www.linkedin.com/in/nadeemlinkedin">Nadeem Khan</a> figured out all those pesky details about usage of
Robolectric, and <a href="https://www.linkedin.com/pub/hans-reichenbach/20/94b/5b8">Hans Reichenbach</a> put a lot of these integration
steps in writing on our wiki. Thanks guys!</p>

    <p><a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing</a></p>
  </li>
</ul>


	  </section>



	</article>
</div>
</section>


		
		
		
		<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/14/android-unit-testing-part-3">Android Unit Testing Part III&#58; Disintegration</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  
		    <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  
		  
		  
		  
		    <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  
	      <span class="sepr">&middot;</span>
	      <time datetime="2015-04-14">
	      April 14, 2015
	      </time>
	    </div>
	  </header>

	  <section class="post-content">
	    <p><em>This is the third of a four part series on Android Unit Testing. In
the last two articles I discussed the <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">general principles of having
good
tests</a>
and the way to <a href="/blog/2015/04/07/android-unit-testing-part-2">run Android tests on JVM making them
fast</a>. This
part will show how to make your Android code less heavily
coupled. This is a preparation step to ensure that your tests are
isolated from each other.</em></p>

<p>We want to test each unit of work separately to make sure that each
piece of our machinery is working properly. We need to be able to
inject all dependencies into classes under the test (instead of this
class instantiating a production dependency). I am not a fan of
manual dependency injection (i.e., passing them through a
constructor or setters). Such a manual method requires a lot of code
and drags all dependencies through multiple classes to inject them
into the end class.</p>

<p>There are a lot of dependency injection frameworks for Android out
there: Dagger, RoboGuice, SpringAndroid, Guice, and Transfuse are a
few. I won’t go into a detailed comparison, but I like Dagger the
most because it provides compile time injection, and doesn’t
influence runtime (specifically startup time) too much.</p>

<p>Again, here there are detailed tutorials at the end of this post and
my summary is below:</p>

<h2 id="my-summary">My Summary</h2>

<ul>
  <li>
    <p>Modify the application Gradle file</p>

    <p>Add the following code under the dependency section:</p>

    <pre><code>compile 'com.squareup.dagger:dagger:1.2.1'
provided 'com.squareup.dagger:dagger-compiler:1.2.1'
</code></pre>
  </li>
  <li>
    <p>Modify the manifest</p>

    <p>Add the following code to the Application tags:</p>

    <pre><code>android:name=“.MyApplication"
</code></pre>
  </li>
  <li>
    <p>Create the classes</p>

    <p>Add the <code>MyApplication</code> class.</p>

    <pre><code>public class MyApplication extends Application {
    private ObjectGraph applicationGraph;
    
    @Override
    public void onCreate() {
        super.onCreate();
            
        applicationGraph = ObjectGraph.create(getModules().toArray());
    }
    
    protected List&lt;Object&gt; getModules() {
        return Arrays.&lt;Object&gt;asList(
                new MyModule(this)
        );
    }
    public void inject(Object object) {
        applicationGraph.inject(object);
    }
}
</code></pre>
  </li>
  <li>
    <p>Add the <code>MyModule</code> class.</p>

    <pre><code>package com.example.myapplication;
      
import dagger.Module;
import dagger.Provides;
    
@Module(
        injects = {
                MainActivity.class
        }
)
public class MyModule {
    private final MyApplication application;
        
    public MyModule(MyApplication application) {
        this.application = application;
    }
}
</code></pre>
  </li>
  <li>
    <p>Modify <code>MainActivity</code> and replace code <code>private Foo
foo = new Foo();</code> with:</p>

    <pre><code>@Inject
Foo foo;
</code></pre>

    <p>and add following code to <code>onCreate()</code>:</p>

    <pre><code>// This will inject all @Inject members 
// recursively for everything what is marked as @Inject
((MyApplication)getApplicationContext()).inject(this);
</code></pre>
  </li>
  <li>
    <p>Modify the <code>Foo</code> class and replace code <code>Bar bar = new Bar();</code> with:</p>

    <pre><code>@Inject
Bar bar;
</code></pre>

    <p>Modify Bar class and add</p>

    <pre><code>@Inject
Bar() {
}
</code></pre>
  </li>
</ul>

<p>Now, instances of <code>Foo</code> and <code>Bar</code> are
automatically injected in the runtime. However, your test will fail
with NPE, because the Foo class has a Bar dependency which wasn’t
delivered. I.e., we don’t want it injected by Dagger -— we want mocked
dependency, not a real one.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://antonioleiva.com/dependency-injection-android-dagger-part-1/">Dependency injection on Android: Dagger (Part 1)</a></li>
  <li><a href="http://antonioleiva.com/dagger-android-part-2/">Dependency injection on Android: Dagger (Part 2)</a></li>
</ul>

<p>Stay tuned for the final part of our series, where I will show you
how to make tests isolated. You can also check out the full code at
<a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">GitHub</a>.</p>


	  </section>



	</article>
</div>
</section>


		
		
		
		<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/07/android-unit-testing-part-2">Android Unit Testing Part II&#58; Escaping Dalvik’s Hold</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  
		    <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  
		  
		  
		  
		    <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  
	      <span class="sepr">&middot;</span>
	      <time datetime="2015-04-07">
	      April 7, 2015
	      </time>
	    </div>
	  </header>

	  <section class="post-content">
	    <p><em>This is the second of a four part series on Android Unit Testing. In
these posts, we’ll walk through the key steps engineers should take
to make Android test fast by running them on JVM (versus running
them on emulator).</em></p>

<p><em>For background information on the importance of Android testing, <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">visit Part I of the series</a>.</em></p>

<p>It appears that the need to run tests on an Android device or an
emulator has concerned Android engineers for almost as long as Android
has existed – and <a href="https://www.linkedin.com/pub/christian-williams/8/4/30b">Christian Williams</a> created <a href="http://robolectric.org/">Robolectric</a> to solve
this problem. Robolectric allows you to run unmodified test code
(referring to Android specific classes) on your desktop (in a JVM)
instead of running them on an emulator or device in the Android
Virtual Machine, or <a href="http://en.wikipedia.org/wiki/Dalvik_%28software%29">Dalvik</a>.</p>

<p>I have listed several good tutorials at the end of this post that
illustrate exactly how this can be done, but they also include some
details you may not yet need. So, use the tutorial links for details,
but check out “My Summary” for a short overview of what you need to
do:</p>

<h2 id="my-summary">My Summary</h2>

<ul>
  <li>
    <p>Create a new project in Android Studio (I used Studio 0.8.14)</p>

    <p>Choose as example Blank Activity project.</p>
  </li>
  <li>
    <p>Modify the TOP Gradle file</p>

    <p>Add the following code to the dependencies section:</p>

    <pre><code>classpath 'org.robolectric:robolectric-gradle-plugin:0.12.+'
</code></pre>
  </li>
  <li>
    <p>Modify the application Gradle file</p>

    <p>Add the following code under <code>apply plugin: ‘com.android.application'</code>:</p>

    <pre><code>apply plugin: ‘robolectric'
</code></pre>
  </li>
  <li>
    <p>Add the following under the dependencies section:</p>

    <pre><code>androidTestCompile('junit:junit:4.11')
androidTestCompile(‘org.robolectric:robolectric:2.3')
</code></pre>
  </li>
  <li>
    <p>Add this section:</p>

    <div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>robolectric { 
        include <span class="string"><span class="delimiter">'</span><span class="content">**/*Test.class</span><span class="delimiter">'</span></span>
}
</pre></div>
</div>
    </div>
  </li>
  <li>
    <p>Create the code that you want to test</p>

    <p>Modify <code>MainActivity</code>. Add the following code to it:</p>

    <div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="directive">private</span> Foo foo = <span class="keyword">new</span> Foo();
<span class="directive">public</span> <span class="type">int</span> getSomething() {
    <span class="keyword">return</span> foo.getFoo();
}
</pre></div>
</div>
    </div>

    <p>Add the <code>Foo</code> class:</p>

    <div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="keyword">package</span> <span class="namespace">com.example.myapplication</span>;
      
<span class="directive">public</span> <span class="type">class</span> <span class="class">Foo</span> { 
    Bar bar = <span class="keyword">new</span> Bar();
        
    <span class="directive">public</span> <span class="type">int</span> getFoo() { 
        <span class="keyword">return</span> bar.getBar(); 
    }
}
</pre></div>
</div>
    </div>
  </li>
  <li>
    <p>Add the <code>Bar</code> class:</p>

    <pre><code>package com.example.myapplication;
    
public class Bar {
        
    public int getBar() { 
        return 4; 
    } 
}
</code></pre>
  </li>
  <li>
    <p>Create a test</p>

    <p>Delete the <code>ApplicationTest</code> file.</p>

    <p>Create the following <code>FooTest</code> class under your <code>androidTest</code>:</p>

    <pre><code>package com.example.myapplication;
    
import junit.framework.Assert;
    
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.RobolectricTestRunner;
    
@RunWith(RobolectricTestRunner.class)
public class FooTest {
    Foo sut;
        
    @Before
    public void setUp() {
        sut = new Foo();
    }
    
    @Test
    public void testGetFoo_returns4() {
        // Arrange
            
        // Act
        int actualResult = sut.getFoo();
            
        // Assert
        Assert.assertEquals(4, actualResult);
    }
}
</code></pre>
  </li>
  <li>
    <p>Create the configuration</p>

    <ol>
      <li>Create a <strong>gradle</strong> configuration.</li>
      <li>Set “<strong>Tests</strong>” as a name.</li>
      <li>Choose the top gradle file as a project.</li>
      <li>Type <em>test</em> in <strong>Tasks</strong>.</li>
    </ol>

    <p>Now, without launching the emulator, you can run this configuration
and see that your test has passed. It is much faster than before—and
repeatable. You can put this under build automation and it will
totally work.</p>
  </li>
  <li>
    <p>JVM</p>

    <p>There are alternative ways to run the test on a JVM. For example,
you can create a <strong>JUnit</strong> task and ensure that all your tests and
classes don’t touch any Android specific classes. However, this is
not easy, as you must design all your code with this restriction in
mind.</p>

    <p>The changes which we did to run on JVM are great, but we are still
facing the limitations of using integration tests. For example, if
the implementation of a <code>Bar</code> class changes and now uses the network,
you might start seeing flakiness in the <code>testGetFoo_returns4</code> test
because of a bad network connection.</p>
  </li>
</ul>

<h2 id="additional-resources">Additional Resources</h2>

<ul>
  <li><a href="https://github.com/codepath/android_guides/wiki/Robolectric-Installation-for-Unit-Testing">Robolectric Installation for Unit Testing</a></li>
  <li><a href="http://www.peterfriese.de/android-testing-with-robolectric/">Android Testing With Robolectric</a></li>
  <li><a href="https://github.com/robolectric/robolectric-gradle-plugin">Robolectric Gradle Plugin</a></li>
</ul>

<p>Stay tuned for part three of our series, where I will show you how
to achieve test isolation using dependency injection. You can also
check out the full code at <a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">GitHub</a>.</p>


	  </section>



	</article>
</div>
</section>


		
	</div>

</section>
		
		
		<section id="bottom-cta" class="section--full-width bg--blue text-align--center">
			<div class="wrap">
			
				<header>
					<h2>Get Started with Okta Now!</h2>
					<p class="text--medium">Your identity layer is ready to go. Getting started takes just a few minutes.</p>
				</header>
				
				<a href="https://www.okta.com/developer/signup/" class="button--large"><span>Get a Free Developer Account</span></a>
			
			</div>
		</section>
		
			
	</div>
	
	<!-- Remarketing tag -->
	<script type="text/javascript">
		/* <![CDATA[ */
		var google_conversion_id = 1006913831;
		var google_custom_params = window.google_tag_params;
		var google_remarketing_only = true;
		/* ]]> */
	</script>
	<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
	</script>
	<noscript>
		<div style="display:inline;">
			<img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"/>
		</div>
	</noscript>
<!-- End Remarketing tag -->

<!-- Crazy Egg Tracking -->
<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>
<!-- End Crazy Egg Tracking -->

<footer class="site-footer">
	<div class="wrap">

		<ul>
			<li><a href="http://www.okta.com" target="_blank">Okta.com</a></li>
			<li><a href="/blog">Blog</a></li>
			<li><a href="/terms/">Terms &amp; Conditions</a></li>
			<li><a href="/privacy/">Privacy Policy</a></li>
			<li><a href="http://okta.com/developer/contact/">Contact Sales</a></li>
			<li><a href="mailto:developers@okta.com">Contact Support</a></li>
		</ul>

		<ul>
			<li><a class="icon-with-hover--github" href="http://github.com/okta" target="_blank">Github</a></li>
			<li><a class="icon-with-hover--twitter" href="http://twitter.com/okta" target="_blank">Twitter</a></li>
			<li><a class="icon-with-hover--stack-overflow" href="http://stackoverflow.com/search?q=okta" target="_blank">Stack Overflow</a></li>
			<li><a class="icon-with-hover--rss" href="http://feeds.feedburner.com/OktaBlog" target="_blank">News</a></li>
			<li><a class="icon-with-hover--help" href="http://community.okta.com" target="_blank">Help</a></li>
		</ul>

	</div>
</footer>

	
</body>
	
</html>